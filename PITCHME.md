# Web Python

@fa[code fa-3x]

Веб приложения на Python. Flask и Django.

> Часть первая

---?image=img/0-green-python-web.jpg&size=contain

---

## Содержание

@ul

- Веб приложения
- Веб и Питон
- Flask
- Тестирование

@ulend

Note:

Для начала рассмотрим что из себя представляет веб приложение в целом;
какие бывают архитектурные и концептуальные подходы и т.п.

- Заострить внимание на применении и структуре приложений
- Какие из них мы рассмотрим подробней, на примере фреймворков питона

---

## Web

- Общая идея
- Какие бывают приложения
- Архитектура

Note:

- динамическая веб страница и веб приложение

---

### Веб приложение это

Приложение, в котором клиент взаимодействует с сервером

@ul
- клиентская часть реализует пользовательский интерфейс, формирует запросы к серверу и обрабатывает ответы от него
- серверная часть получает запрос от клиента, выполняет требуемые действия, формирует ответ
@ulend

Note:

- чаще всего, посредством браузера
- обозначить понятия фронтенд и бэкенд
- немного про то, как это появилось и развивается

---

### Классическая схема

![Legacy Web app](img/1-web-app.png)

Note:

- Клиент обращается к приложению, которое генерирует в ответ статический html
- Клиент может отправлять GET и POST, получая или отправляя данные

---

### Асинхронные виджеты

![Widgets](img/2-web-app.png)

Note:

- Отдельные элементы на странице обновляются асинхронно, через особые
взаимодействия с бэкендом
- Asynchronous Javascript and XML

---

### Single Page Application

![SPA](img/3-web-app.png)

Note:

- фронтенд и бэкенд существуют отдельно друг от друга
- потенциально, бэкенд (или фронтенд) можно полностью заменить на другой, без
особых проблем
---

### Общая схема

![Web application at a glance](img/4-web-app.png)

Note:

- CGI: общий интерфейс шлюза, как его именуют, изначально был только для форм
- может включать в себя очень много чего
- в лекциях будем рассматривать преимущественно само "приложение"
- но также затронем и остальные моменты: фронтенд, деплой и т.п.

---

### Обратить внимание

@ul

- Frontend содержит HTML, CSS, JS - интерфейс для пользователя
- Backend предоставляет "интерфейс" для фронтенда
- На деле граница между ними бывает довольно размытой
- Последние тенденции как сближают, так и разделяют эти два компонента веб приложений

@ulend

Note:

Необходимо подвести к разделению на frontend/backend и рассказать подробней о
грани (или её отсутствии) между ними.

---

### Базовые функции веб приложения

@ul

- отображение страниц
- авторизация, аутентификация и разграничение доступа
- обработка, вывод и сохранение пользовательских данных
- фоновые и утилитарные задачи

@ulend

---


## Инструментарий

@ul

- Встроенные модули питона
- Flask
- Django
- Прочие (Bottle, Pyramids, Tornado, Eve)

@ulend

---

### HTTP server

Доступен "из коробки", реализован на основе `socketserver.TCPServer`

> python -m http.server 8000

---?code=src/1-http-server.py&lang=py&color=white&title=Http server example

@[1-2](Импортируем socketserver и HTTP обработчик)
@[3-5](Модули логгирования и работы с файловой системой)
@[7](Назначим свою версию обработчика HTTP запросов)
@[9-11](Переопределяем метод GET)
@[13](Модифицируем стартовую директорию)
@[15-16](Запускаем сервер с нашим HTTP обработчиком)


Note:
- форматирование отчасти обусловлено максимальной шириной сегмента кода
- по умолчанию раздаёт текущую директорию или файл index.html
- модифицируем текущую директорию и метод GET

---

## Flask

@ul

- Установка и конфигурация
- Примеры функциональности
- Структура проекта
- Blueprints
- Готовые модули
- Дополнительные примеры

@ulend

Note:

- почему Flask это микро-фреймворк
- Flask как проект-шутка (немного об истории)
- что включает в себя Flask

---

### Flask. Вступление

@ul

- Имплементирует WSGI приложение
- Встроенный шаблонизатор Jinja2
- Множество готовых расширений
- Минималистичный и протестированный
- Простая конфигурация, API и setup
- Bring Your Own Batteries
- Появился в качестве первоапрельского проекта

@ulend

Note:

- упомянуть про Werkzeug (инструмент) WSGI web application library/utilities
- WSGI рассмотрим дальше

---

### Flask. Рабочее окружение

```bash
pip intall pipenv

pipenv install flask

pipenv shell
```

*Pipenv* - Священный союз Pipfile, Pip, и Virtualenv.

Note:

- для данного приложения задействуем виртуальное окружение
- дальше рассмотрим альтернативные варианты создания development окружения
- упомянуть Poetry и прочие

<!-- ### Flask. Простое приложение -->

---?code=src/flask/1-simple.py&lang=py&color=white&title=Flask. Basics
@[1](Импортируем Flask и его утилиты)
@[3](Создаём приложение)
@[5-7](Назначаем маршрут 'Hello World')
@[9-11](Добавляем редирект с корневого url)
@[13-14](Запускаем приложение)

---

### Flask. Переменные окружения

```bash
set FLASK_APP=1-simple.py
```

Flask, python-dotenv и Pipenv позволяют задать определённые переменные
рабочего или серверного окружения.

```bash
# .env
FLASK_APP=1-simple.py
FLASK_ENV=development
FLASK_RUN_PORT=8000
VERY_SECRET_KEY=qwerty
```

> flask run

Note:

- показать на примере имеющегося .env
- показать printenv и grep'нуть python переменные
- запустить через flask run с предварительным export FLASK_APP
- упомянуть параметр host

---

### Flask. Read-Eval-Print-Loop

> flask shell

```python
>>> app.name
'1-simple'

>>> app.view_functions
{'static': <bound method _PackageBoundObject.send_static_file of <Flask '1-simple'>>,
 'hello': <function hello at 0x000001FF97680598>,
 'home': <function home at 0x000001FF97680730>}

>>> app.view_functions['hello']('Man')
'Hello Man!'
```
@[1-2](Наше приложение)
@[4-7](Маршруты/методы)
@[9-10](Пытаемся вызвать метод hello)

Note:

- что такое bound method vs function
- что это за метод такой, send_static_file

<!-- ### Flask. Шаблон -->

---?code=src/flask/2-template.py&lang=py&color=white&title=Flask. Using templates
@[5](Обозначим данные)
@[9](Выведем данные в шаблон)

Note:

Пару минут на демонстрацию, можно что-нибудь модифицировать в рамках
jinja конструкций

---?code=src/flask/templates/fish.html&lang=html&color=white&title=Flask. Template
@[1,2,12](Это HTML страница)
@[3-5](Назовём её согласно содержимому)
@[6-11](Выведем в цикле всех рыбок)

Note:

- файлы шаблонов надо где-то хранить
- шаблонизаторы и что это такое
- более подробно рассмотрим на примере шаблонизатора Django

<!-- Flask. Запросы -->

---?code=src/flask/3-request.py&lang=py&color=white&title=Flask. Request
@[1-2](Задействуем дополнительные модули Flask)
@[3-4](Для пущего удобства)
@[6-10](Эмулируем некое подобие сервиса для получения данных)
@[14-15](Назначаем маршрут для получения информации о записи)
@[16-18](Обрабатываем GET параметр)
@[19-21](Получаем запись из сервиса)
@[23-26](Форматируем и возвращаем данные в качестве ответа)
@[28-29,30,33](Маршрут для перечисления и добавления записей)
@[30-31](Выводим все имеющиеся записи)
@[35-38](Обрабатываем POST запрос)
@[34,40-41](Проверяем запрос на возможные ошибки)

Note:

- атрибуты request'а: фрагменты url, параметры get, данные POST'а
- Content-Type: может быть multipart/form-data, text/plain, etc
- обратить внимание на возможные ошибки: json.loads, ключ name и прочее
- с этим кодом что-то не так: вопрос про form.get(..)

---

### Flask. Пример запроса

> curl -d "name=corydoras&size=medium" -X POST http://localhost:5000/

Различные утилиты для HTTP запросов:

- httpie
- Postman
- Insomnia (бывший Hurl.it)

Note:

- 2 минуты на демонстрацию
- показать сами утилиты или сайты

---

### Flask. Структура проекта

Готовые шаблоны для различных приложений, в том числе и для Python.

> cookiecutter gh:user/repo

Note:

Утилита написана на Python

---

### Flask. Пример структуры проекта

```bash
.
├── .env                    # переменные окружения
├── run.py                  # точка входа в приложение
├── client.js               # точка входа для фронтенда
└── app
    ├── client
    │   ├── build           # артефакты фронтенда
    │   ├── static          # JS, CSS, картинки
    │   └── templates       # шаблоны
    └── server
        ├── config.py       # конфигурация приложения
        ├── main            # главный модуль
        │   └── views.py    # маршруты
        ├── models.py       # модели данных
        └── user            # модуль пользователя
```
@[2-4](Может содержать прочие утилиты и файлы конфигурации)
@[5-15](Само приложение Flask)
@[6-9](Всё что связано с фронтендом)
@[10-15](Бэкенд и прочая логика)
@[12-13](Отдельный Blueprint)

Note:

- Pipenv, .env и переменные окружения
- упомянуть про cli и инструментарий, БД, утилиты
- упомянуть про client pipeline и что он делает
- что такое загадочные "артефакты фронтенда"

---

### Flask. Blueprints

Blueprint - модуль приложения, обособленный согласно определённой логике

```bash
app/
    errors/                 # модуль ошибок
        __init__.py         # инициализация модуля
        handlers.py         # обработка ошибок
    templates/
        errors/             # шаблоны ошибок
            404.html
            500.html
    __init__.py             # регистрируем blueprint
```

<!-- Пример Blueprint'а -->

---?code=src/flask/4-blueprint.py&lang=py&color=white&title=Flask. Errors Blueprint
@[1-6](Инициализация модуля ошибок)
@[10-17](Пример обработчика ошибки 404)
@[20-25](Подключение модуля к основному приложеню)

Note:

- __init__.py как маркер директории, содержащей package
- также может содержать инструкции по инициализации

---

### Flask. Готовые модули

Для расширения функциональности Flask доступно большое количество модулей:

@ul

- **Flask-Login**: сессия и авторизация
- **Flask-Admin**: административный интерфейс
- **Flask-Restful**: создание REST API
- **Flask-SQLAlchemy**: работа с базой данных
- **Flask-Migrate**: создание миграций

@ulend

https://github.com/humiaozuzu/awesome-flask

Note:

- с миграциями и ORM'ом познакомимся в рамках Django
- тоже самое и с административным интерфейсом

### Flask. Немного фронтенда

<!-- ### Flask. Асинхронный виджет -->
---?code=src/flask/5-widget.py&lang=py&color=white&title=Flask. Widget
@[6](Задействуем модуль Restful)
@[9-10](Некое подобие уникального ключа)
@[13-21](Наша импровизированная БД)
@[21-26](API и обработка ошибок)
@[28-32](Зададим обработку аргументомв)
@[35-37](Отобразим сам шаблон)
@[40](Обозначим ресурсы)
@[41-42](Получение всех записей)
@[44-53](Добавление новой)
@[57-63](Операции с одной конкретной записью)
@[66-67](Добавим соответствующие маршруты)
@[70-72](Обработчик для статических файлов)

Note:

- обратить внимание на неудобство использования namedtuple
- если будет время, отметить обработку данных на фронтенде

---?code=src/flask/templates/widget.html&lang=html&color=white&title=Flask. Widget. Template
@[29](Наш виджет, разметка)
@[34-36](Разметка для добавления записи)
@[39-45](Выводим записи в две колонки)
@[56-57](Воспользуемся Vue и Axios)
@[58](Подключим логику виджета)


---?code=src/flask/static/widget.js&lang=js&color=white&title=Flask. Widget. JS
@[1](Адрес нашего приложения)
@[2-3](Инициализируем Vue)
@[26-32](Получаем список всех записей)
@[15-24](Разделяем их на две группы)
@[33-37](Добавим новую запись)
@[38-41](Удалим запись по клику)


---?code=src/flask/6-forms.py&lang=py&color=white&title=Flask. Form
@[3-4](Подключим WTForms)
@[10-12](Обозначим форму и поле)
@[14-17](Отобразим данную форму)
@[19-26](Обрабатываем сабмит формы)

Note:

- объекты невыясненной природы и назначения

---?code=src/flask/templates/layout.html&lang=html&color=white&title=Flask. Form. Layout
@[10-11](Блок для нашей формы)
@[16-17](Блок для скриптов)
@[5-7,13-14](Всевозможные библиотеки)

---?code=src/flask/templates/form.html&lang=js&color=white&title=Flask. Form. Template
@[1](Наследуем от главного шаблона)
@[3-8](Контент: наша форма)
@[11-12](Блок для JS скриптов)
@[13-17](Подпись для нашего POST запроса)
@[20](Предотвращаем сабмит формы по умолчанию)
@[22-25](Отправляем данные)
@[26-32](Обрабатываем успешный ответ)
@[33-39](Обрабатываем провал)
@[42](Привязываем наш обработчик к событию самбита формы)

---

### Flask. Практики

---?code=src/flask/7-practices.py&lang=py&color=white&title=Flask. Practices
@[1-9](Создаём и настраиваем приложение)
@[11-17](Обращаемся к текущему приложению Flask и получаем параметры)
@[21-29](Передаём переменную во все представления)
@[33-46](Декоратор для маршрута)
@[34, 36](Декоратор и декорируемая функция)
@[35](Сохраняем информацию функции)
@[37-40](Увеличиваем количество просмотров)
@[41-43](Сбрасываем количество просмотров)
@[44, 46](Возвращаем результаты вызова функции)
@[48-52](Обернём наш маршрут)

Note:

- удобство тестирования
- избегаем циклических зависимостей
- единая точка входа
- вспомнить про декораторы
- порядок декорирование важен

---?code=src/flask/templates/san-juan.html&lang=html&color=white&title=Flask. Another template

---

### Flask. Заключение

@ul

- Прекрасно подходит для прототипирования
- Минималистичен и прямолинеен в использовании
- Конструктор "собери сам": расширение за счёт сторонних модулей
- Потенциально хорошо масштабируется
- Декларативное назначение маршрутов

@ulend

---

---?code=src/flask/8-tests.py&lang=python&color=white&title=Flask. Tests
@[5-16](Создаём приложение в отдельном методе)
@[12-14](Маршрут для возведения в степень)
@[18-20](Запускаем приложение)
@[23-25](Фикстура для тестирования)
@[27-29](Проверим, работает ли приложение)
@[31-33](Проверим нам маршрут для возведения в степень)
@[37-40](Проверим пограничные условия)

---

### Flask. Собери сам

@ul

- OpenAPI
- Swagger UI, Flasgger, Eve
- Marshmallow, Cerberus
- Flask CLI
- Flask JWT-extended

@ulend

---

## Ссылки

Данная презентация
https://gitpitch.com/xifax/lectures-python-web/master

Репозиторий презентации
https://github.com/xifax/lectures-python-web

Репозиторий содержит примеры кода, картинки, тексты и "заметки на полях".
